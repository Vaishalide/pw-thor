<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DRM Video Player</title>
  <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.3.5/dist/shaka-player.compiled.js"></script>
  <style>
    body { background: #000; margin: 0; }
    video { width: 100%; height: 100vh; }
  </style>
</head>
<body>
  <video id="video" autoplay controls></video>

 <script>
  async function initPlayer() {
    const response = await fetch('/krta.json');
    const data = await response.json();

    const video = document.getElementById('video');
    const player = new shaka.Player(video);
    window.player = player;

    // Add error event logger
    player.addEventListener('error', (e) => {
      const err = e.detail;
      console.error("Shaka Error", err);
    });

    // Configure DRM if ClearKey
    if (data.drmType === "ClearKey") {
      const keyMatch = data.key_strings.match(/--key\s+([a-fA-F0-9]+):([a-fA-F0-9]+)/);
      if (keyMatch) {
        const keys = { [keyMatch[1]]: keyMatch[2] };
        player.configure({
          drm: {
            clearKeys: keys
          }
        });
      } else {
        console.error("Invalid key format in krta.json");
        return;
      }
    }

    try {
      await player.load(data.url);
      console.log("Video loaded successfully.");
    } catch (error) {
      console.error("Error initializing Shaka Player:", error);
    }
  }

  shaka.polyfill.installAll();
  if (shaka.Player.isBrowserSupported()) {
    initPlayer();
  } else {
    alert("Shaka Player not supported.");
  }
</script>

</body>
</html>
