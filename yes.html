<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DRM Video Player</title>
  <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.3.5/dist/shaka-player.compiled.js"></script>
  <style>
    body { background: #000; margin: 0; }
    video { width: 100%; height: 100vh; }
  </style>
</head>
<body>
  <video id="video" autoplay controls></video>

  <script>
    const VIDEO_API = "/krta.json";

    function base64ToUint8Array(base64) {
      const raw = atob(base64);
      const uint8Array = new Uint8Array(raw.length);
      for (let i = 0; i < raw.length; ++i) {
        uint8Array[i] = raw.charCodeAt(i);
      }
      return uint8Array;
    }

    async function initPlayer() {
      try {
        const response = await fetch(VIDEO_API);
        const data = await response.json();

        const video = document.getElementById("video");
        const player = new shaka.Player(video);
        window.player = player;

        // ClearKey DRM
        if (data.drmType === "ClearKey" && data.key_strings) {
          const keyMatch = data.key_strings.match(/--key\s+([a-fA-F0-9]+):([a-fA-F0-9]+)/);
          if (keyMatch) {
            const keys = { [keyMatch[1]]: keyMatch[2] };
            player.configure({
              drm: {
                clearKeys: keys
              }
            });
          } else {
            console.error("Invalid key_strings format.");
            return;
          }
        }

        const manifestUrl = `https://pw-player-7b8d4bce9043.herokuapp.com/proxy?url=${encodeURIComponent(data.url)}`;

        // Load with explicit initData if pssh is provided
        const initData = base64ToUint8Array(data.pssh);
        await player.load(manifestUrl, 0, 'cenc', initData);
        console.log("Video loaded successfully.");
      } catch (error) {
        console.error("Error initializing Shaka Player:", error);
      }
    }

    shaka.polyfill.installAll();
    if (shaka.Player.isBrowserSupported()) {
      initPlayer();
    } else {
      alert("Shaka Player is not supported in this browser.");
    }
  </script>
</body>
</html>
