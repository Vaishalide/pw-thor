<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PW THOR ‚Äì Squid Game Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link href="https://www.pw.live/favicon.ico" rel="icon" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root {
      --sg-bg: #121212;
      --sg-card: #1a1a1d;
      --sg-pink: #ff4f81;
      --sg-green: #2fff8d;
      --sg-dark: #0f0f10;
    }

    body {
      background: var(--sg-bg);
      color: #f0f0f0;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 1rem;
    }

    h1 {
      text-align: center;
      color: var(--sg-green);
      text-shadow: 0 0 10px var(--sg-green);
    }

    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      justify-content: center;
      margin-top: 1rem;
    }

    .card {
      background: var(--sg-card);
      border-left: 5px solid var(--sg-pink);
      border-radius: 10px;
      padding: 1rem;
      width: 260px;
      cursor: pointer;
      transition: 0.3s ease;
    }

    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 0 12px var(--sg-pink);
    }

    .card img {
      width: 100%;
      border-radius: 8px;
    }

    .card-title {
      margin-top: 10px;
      font-weight: bold;
      font-size: 1rem;
      color: #fff;
    }

    #searchInput {
      display: block;
      width: 90%;
      max-width: 400px;
      margin: 1rem auto;
      padding: 0.75rem 1rem;
      border-radius: 50px;
      background: var(--sg-dark);
      border: 2px solid var(--sg-green);
      color: white;
      font-size: 1rem;
    }

    .back-btn {
      margin: 1rem 0;
      font-weight: bold;
      color: var(--sg-pink);
      cursor: pointer;
      display: none;
    }

    .today-classes-wrapper {
      margin-top: 1rem;
    }

    .today-classes-title {
      font-size: 1.2rem;
      color: var(--sg-pink);
      margin: 0 0 10px 10px;
    }

    .today-classes-container {
      overflow-x: auto;
      white-space: nowrap;
      padding: 10px;
      background: var(--sg-card);
      border-radius: 10px;
    }

    .today-card {
      display: inline-block;
      width: 220px;
      background: var(--sg-dark);
      margin-right: 10px;
      padding: 10px;
      border-radius: 10px;
    }

    .today-card img {
      width: 100%;
      border-radius: 6px;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .spinner {
      border: 6px solid #333;
      border-top: 6px solid var(--sg-green);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .lecture-tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 1rem 0;
    }

    .lecture-tabs button {
      background: var(--sg-pink);
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
    }

    .lecture-tabs button.active {
      background: var(--sg-green);
      color: #111;
    }

    #loadMoreChaptersWrapper {
      text-align: center;
      margin-top: 1rem;
    }

    #loadMoreChaptersBtn {
      padding: 10px 20px;
      border: none;
      background: var(--sg-green);
      color: #111;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div style="text-align: center;">
    <img src="ChatGPT Image May 7, 2025, 08_57_25 PM.png" style="height: 60px;" alt="Logo" />
    <h1>PW THOR</h1>
  </div>

  <input type="text" id="searchInput" placeholder="Search batch by name..." />
  <div class="overlay" id="overlay"><div class="spinner"></div></div>
  <div id="backBtn" class="back-btn">‚Üê Back</div>

  <div class="today-classes-wrapper" id="todayWrapper" style="display:none;">
    <div class="today-classes-title">üìÖ Today's Classes</div>
    <div class="today-classes-container" id="todayClasses"></div>
  </div>

  <div id="main" class="grid"></div>
  <div id="subjects" class="grid" style="display:none;"></div>
  <div id="chapters" class="grid" style="display:none;"></div>

  <div id="loadMoreChaptersWrapper" style="display: none;">
    <button id="loadMoreChaptersBtn">Load More Chapters</button>
  </div>

  <div id="lectureSection" style="display:none;">
    <div class="lecture-tabs">
      <button onclick="switchTab('vidoes')" id="tab-vidoes">Lectures</button>
      <button onclick="switchTab('notes')" id="tab-notes">Notes</button>
      <button onclick="switchTab('DppNotes')" id="tab-DppNotes">DPP Notes</button>
      <button onclick="switchTab('DppVideos')" id="tab-DppVideos">DPP Lectures</button>
    </div>
    <div class="grid" id="lectureContent"></div>
  </div>
<script>
  const API_BASE = "https://pw-api-75332756c41b.herokuapp.com";
  const overlay = document.getElementById("overlay");
  const backBtn = document.getElementById("backBtn");
  const main = document.getElementById("main");
  const subjects = document.getElementById("subjects");
  const chapters = document.getElementById("chapters");
  const lectureSection = document.getElementById("lectureSection");
  const lectureContent = document.getElementById("lectureContent");
  const todayWrapper = document.getElementById("todayWrapper");
  const todayClasses = document.getElementById("todayClasses");
  const chapterLoadMoreBtn = document.getElementById("loadMoreChaptersBtn");
  const chapterLoadMoreWrapper = document.getElementById("loadMoreChaptersWrapper");

  let viewStack = [];
  let allBatches = [];
  let currentBatchId = "", currentSubjectSlug = "", currentTopicId = "", currentContentType = "vidoes", currentSubjectId = "";
  let chapterPage = 1, chapterTotal = Infinity, chapterLoading = false;
  let lecturePage = 1, lectureTotal = Infinity, lectureLoading = false;

  function showLoader(flag) {
    overlay.style.display = flag ? "flex" : "none";
  }

  function clearAll() {
    [main, subjects, chapters, lectureSection].forEach(el => el.style.display = "none");
    todayWrapper.style.display = "none";
    backBtn.style.display = viewStack.length ? "block" : "none";
  }

  function show(el) {
    clearAll();
    el.style.display = el === lectureSection ? "block" : "flex";
  }

  function appendCard(container, title, image, onClick) {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `${image ? `<img src="${image}" />` : ""}<div class="card-title">${title}</div>`;
    div.onclick = onClick;
    container.appendChild(div);
  }

  async function loadBatches() {
    showLoader(true);
    try {
      const res = await fetch(`${API_BASE}/api/batches`);
      const data = await res.json();
      allBatches = data.batches.map(b => ({ name: b.name, image: b.previewImage, id: b._id }));
      renderBatches(allBatches);
    } catch (err) {
      alert("Failed to load batches");
    } finally {
      showLoader(false);
    }
  }

  function renderBatches(batches) {
    main.innerHTML = "";
    searchInput.style.display = "block";
    show(main);
    batches.forEach(batch => {
      appendCard(main, batch.name, batch.image, () => {
        viewStack.push(() => renderBatches(batches));
        loadSubjects(batch.id);
      });
    });
  }

  async function loadSubjects(batchId) {
    show(subjects);
    backBtn.onclick = () => viewStack.pop()?.();
    currentBatchId = batchId;
    subjects.innerHTML = "";
    todayClasses.innerHTML = "";
    todayWrapper.style.display = "none";

    try {
      const res = await fetch(`${API_BASE}/api/batch/${batchId}`);
      const { data } = await res.json();
      (data.subjects || []).forEach(sub => {
        const img = sub.imageId ? sub.imageId.baseUrl + sub.imageId.key : null;
        appendCard(subjects, sub.subject, img, () => {
          viewStack.push(() => loadSubjects(batchId));
          currentSubjectId = sub.subjectId || sub._id;
          chapterPage = 1;
          chapterTotal = Infinity;
          loadChapters(batchId, sub.slug, 1);
        });
      });

      const todayRes = await fetch(`${API_BASE}/api/batch/${batchId}/todays-schedule`);
      const today = await todayRes.json();
      if (today.length > 0) {
        todayWrapper.style.display = "block";
        today.forEach(cls => {
          const card = document.createElement("div");
          card.className = "today-card";
          card.innerHTML = `${cls.image ? `<img src="${cls.image}" />` : ""}<div class="card-title">${cls.title}</div>`;
          card.onclick = () => launchPlayer(cls.url);
          todayClasses.appendChild(card);
        });
      }
    } catch (e) {
      console.error(e);
      alert("Error loading subjects");
    }
  }

  async function loadChapters(batchId, subjectSlug, page = 1) {
    if (chapterLoading) return;
    if (page === 1) {
      chapters.innerHTML = "";
      chapterTotal = Infinity;
    }
    if (page > Math.ceil(chapterTotal / 20)) return;

    chapterLoading = true;
    showLoader(true);
    currentBatchId = batchId;
    currentSubjectSlug = subjectSlug;
    show(chapters);

    try {
      const res = await fetch(`${API_BASE}/api/batch/${batchId}/subject/${subjectSlug}/topics?page=${page}`);
      const result = await res.json();
      const chaptersData = result.data || [];
      chapterTotal = result.paginate?.totalCount || chaptersData.length;

      chaptersData.forEach(ch => {
        appendCard(chapters, ch.name, null, () => {
          viewStack.push(() => loadChapters(batchId, subjectSlug));
          loadLecturesContent(batchId, subjectSlug, ch._id);
        });
      });

      chapterPage++;
      chapterLoadMoreWrapper.style.display = (chapterPage <= Math.ceil(chapterTotal / 20)) ? "block" : "none";
    } catch (err) {
      alert("Error loading chapters");
    } finally {
      chapterLoading = false;
      showLoader(false);
    }
  }

  async function loadLecturesContent(batchId, subjectSlug, topicId, type = currentContentType, page = 1) {
    if (lectureLoading || page > Math.ceil(lectureTotal / 20)) return;
    if (page === 1) lectureContent.innerHTML = "";

    show(lectureSection);
    showLoader(true);
    lectureLoading = true;

    currentTopicId = topicId;
    currentContentType = type;

    try {
      const res = await fetch(`${API_BASE}/api/batch/${batchId}/subject/${subjectSlug}/topic/${topicId}/all-contents?type=${type}&page=${page}`);
      const data = await res.json();
      const items = data.data || [];
      lectureTotal = data.paginate?.totalCount || items.length;

      items.forEach(item => {
        const div = document.createElement("div");
        div.className = "card";

        if (["notes", "DppNotes"].includes(type)) {
          const links = (item.homeworkIds || []).flatMap(h => h.attachmentIds || []).map(a =>
            `<button onclick="window.open('${a.baseUrl + a.key}', '_blank')">${a.name}</button>`
          ).join("");
          div.innerHTML = `<div class="card-title">${item.topic || "Note"}</div>${links}`;
        } else {
          const vid = item.videoDetails || item;
          const image = vid.image || vid.thumbnail || "";
          const title = vid.name || "Video";
          const mediaUrl = vid.hls_url || item.url || "";

          div.innerHTML = `${image ? `<img src="${image}" />` : ""}<div class="card-title">${title}</div>`;
          div.onclick = async () => {
            showLoader(true);
            try {
              let finalUrl = mediaUrl;

              if (finalUrl.includes("youtube.com") || finalUrl.includes("youtu.be")) {
                window.open(finalUrl, "_blank");
                return;
              }

              if (!finalUrl || finalUrl.trim() === "") {
                const params = [
                  `video_url=`,
                  `title=${encodeURIComponent(vid.name || "")}`,
                  `poster=${encodeURIComponent(image)}`,
                  `video_type=pw`,
                  `video_id=${item._id || ""}`,
                  `subject_id=${currentSubjectId || ""}`,
                  `batch_id=${currentBatchId || ""}`
                ].join('&');

                const resp = await fetch(`${API_BASE}/api/video/stream-info?${params}`);
                const data = await resp.json();
                if (!data.success || !data.m3u8_url) {
                  alert("Video not available.");
                  return;
                }

                finalUrl = data.m3u8_url;
              }

              if (finalUrl.includes("youtube.com") || finalUrl.includes("youtu.be")) {
                window.open(finalUrl, "_blank");
                return;
              }

              window.location.href = `pwplayer.html?playurl=${encodeURIComponent(finalUrl)}`;
            } catch (err) {
              console.error("Video load failed", err);
              alert("Failed to load video.");
            } finally {
              showLoader(false);
            }
          };
        }

        lectureContent.appendChild(div);
      });

      lecturePage++;
    } catch (err) {
      alert("Error loading lectures");
    } finally {
      lectureLoading = false;
      showLoader(false);
    }
  }

  function switchTab(tab) {
    ["vidoes", "notes", "DppNotes", "DppVideos"].forEach(t =>
      document.getElementById("tab-" + t)?.classList.remove("active")
    );
    document.getElementById("tab-" + tab)?.classList.add("active");
    lecturePage = 1;
    lectureTotal = Infinity;
    loadLecturesContent(currentBatchId, currentSubjectSlug, currentTopicId, tab);
  }

  document.getElementById("searchInput").addEventListener("input", e => {
    const q = e.target.value.toLowerCase();
    const filtered = allBatches.filter(b => b.name.toLowerCase().includes(q));
    renderBatches(filtered);
  });

  chapterLoadMoreBtn.onclick = () => {
    loadChapters(currentBatchId, currentSubjectSlug, chapterPage);
  };

  backBtn.onclick = () => {
    const fn = viewStack.pop();
    fn && fn();
  };

  window.onload = loadBatches;
</script>
</body>
</html>
