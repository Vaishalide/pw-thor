<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PW THOR ‚Äì Squid Game UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link href="https://www.pw.live/favicon.ico" rel="icon"/>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body {
      margin: 0;
      background: #111;
      color: #eee;
      font-family: 'Poppins', sans-serif;
      padding: 1rem;
    }
    h1 {
      color: #6ECB63;
      text-shadow: 0 0 6px rgba(110, 203, 99, 0.5);
      text-align: center;
    }
    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .card {
      background: #1A1A1D;
      border-left: 4px solid #FF6699;
      border-radius: 10px;
      padding: 1rem;
      width: 260px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 12px rgba(255, 102, 153, 0.3);
    }
    .card img {
      width: 100%;
      border-radius: 8px;
    }
    .card-title {
      margin-top: 10px;
      font-weight: bold;
      color: #fff;
    }
    #searchInput {
      display: block;
      width: 90%;
      max-width: 400px;
      margin: 1rem auto;
      padding: 0.75rem 1rem;
      border-radius: 30px;
      border: 2px solid #6ECB63;
      background: #1F1F1F;
      color: #fff;
    }
    .back-btn {
      display: none;
      color: #FF6699;
      margin: 10px 0;
      font-weight: bold;
      cursor: pointer;
    }
    .today-classes-wrapper {
      margin: 20px 0;
    }
    .today-classes-title {
      font-size: 1.2rem;
      color: #FF6699;
      margin-left: 1rem;
    }
    .today-classes-container {
      white-space: nowrap;
      overflow-x: auto;
      padding: 10px;
    }
    .today-card {
      display: inline-block;
      width: 220px;
      background: #2C2C31;
      margin-right: 10px;
      padding: 10px;
      border-radius: 10px;
      color: #fff;
    }
    .today-card img {
      width: 100%;
      border-radius: 8px;
    }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }
    .spinner {
      border: 6px solid #333;
      border-top: 6px solid #6ECB63;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div style="text-align: center;">
    <img src="ChatGPT Image May 7, 2025, 08_57_25 PM.png" alt="Logo" style="height: 60px;" />
    <h1>PW THOR</h1>
  </div>

  <input type="text" id="searchInput" placeholder="Search batch by name..." />
  <div class="overlay" id="overlay"><div class="spinner"></div></div>
  <div id="backBtn" class="back-btn">‚Üê Back</div>

  <div class="today-classes-wrapper" id="todayWrapper" style="display:none;">
    <div class="today-classes-title">üìÖ Today's Classes</div>
    <div class="today-classes-container" id="todayClasses"></div>
  </div>

  <div id="main" class="grid"></div>
  <div id="subjects" class="grid" style="display:none;"></div>
  <div id="chapters" class="grid" style="display:none;"></div>
  <div id="lectureSection" style="display:none;">
    <div class="lecture-tabs" style="text-align: center; margin: 1rem;">
      <button onclick="switchTab('vidoes')">Lectures</button>
      <button onclick="switchTab('notes')">Notes</button>
      <button onclick="switchTab('DppNotes')">DPP Notes</button>
      <button onclick="switchTab('DppVideos')">DPP Lectures</button>
    </div>
    <div class="grid" id="lectureContent"></div>
  </div>
  <!-- POPUP Modal -->
  <div id="popup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:#1F1F1F; padding:20px; border-radius:12px; box-shadow:0 0 20px #FF669966; z-index:9999;">
    <button onclick="popup.style.display='none'" style="position:absolute; top:5px; right:10px; background:none; border:none; font-size:18px; color:white;">&times;</button>
    <img id="popupImage" src="" style="width:100%; border-radius:8px;" />
    <p id="popupText" style="margin:10px 0;"></p>
    <a id="popupLink" href="#" target="_blank" style="padding:8px 12px; background:#FF6699; color:#111; text-decoration:none; font-weight:bold; border-radius:5px;">Join Telegram</a>
  </div>

  <!-- TELEGRAM Floating Button -->
  <a href="https://t.me/pwthor_support" target="_blank" style="position:fixed; bottom:20px; right:20px; z-index:1000;">
    <img src="download.png" alt="Telegram" style="width:50px; height:50px; border-radius:50%; box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);" />
  </a>

  <!-- JS Logic -->
  <script>
    const API = "https://pw-api-75332756c41b.herokuapp.com";
    const overlay = document.getElementById("overlay");
    const backBtn = document.getElementById("backBtn");
    const main = document.getElementById("main");
    const subjects = document.getElementById("subjects");
    const chapters = document.getElementById("chapters");
    const lectureContent = document.getElementById("lectureContent");
    const lectureSection = document.getElementById("lectureSection");
    const todayWrapper = document.getElementById("todayWrapper");
    const todayClasses = document.getElementById("todayClasses");
    const searchInput = document.getElementById("searchInput");

    let viewStack = [];
    let allBatches = [], currentBatch = "", currentSubjectSlug = "", currentTopicId = "", currentType = "vidoes";

    function showLoader(flag) {
      overlay.style.display = flag ? "flex" : "none";
    }

    function clearViews() {
      [main, subjects, chapters, lectureSection].forEach(el => el.style.display = "none");
      todayWrapper.style.display = "none";
      backBtn.style.display = viewStack.length ? "block" : "none";
    }

    function show(el) {
      clearViews();
      el.style.display = el === lectureSection ? "block" : "flex";
    }

    function createCard(container, title, img, onClick) {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `${img ? `<img src="${img}" />` : ""}<div class="card-title">${title}</div>`;
      card.onclick = onClick;
      container.appendChild(card);
    }

    async function loadBatches() {
      showLoader(true);
      try {
        const res = await fetch(`${API}/api/batches`);
        const data = await res.json();
        allBatches = data.batches.map(b => ({ name: b.name, image: b.previewImage, id: b._id }));
        renderBatches(allBatches);
      } catch (e) {
        alert("Failed to load batches");
      } finally {
        showLoader(false);
      }
    }

    function renderBatches(list) {
      main.innerHTML = "";
      list.forEach(b => createCard(main, b.name, b.image, () => {
        viewStack.push(() => renderBatches(list));
        loadSubjects(b.id);
      }));
      show(main);
    }

    async function loadSubjects(batchId) {
      currentBatch = batchId;
      show(subjects);
      backBtn.onclick = () => viewStack.pop()?.();
      subjects.innerHTML = "";
      todayClasses.innerHTML = "";
      todayWrapper.style.display = "none";

      try {
        const res = await fetch(`${API}/api/batch/${batchId}`);
        const { data } = await res.json();
        data.subjects.forEach(sub => {
          const img = sub.imageId ? sub.imageId.baseUrl + sub.imageId.key : null;
          createCard(subjects, sub.subject, img, () => {
            viewStack.push(() => loadSubjects(batchId));
            loadChapters(batchId, sub.slug);
          });
        });

        const todayRes = await fetch(`${API}/api/batch/${batchId}/todays-schedule`);
        const today = await todayRes.json();
        if (today.length > 0) {
          todayWrapper.style.display = "block";
          today.forEach(cls => {
            const div = document.createElement("div");
            div.className = "today-card";
            div.innerHTML = `${cls.image ? `<img src="${cls.image}" />` : ""}<div class="card-title">${cls.title}</div>`;
            div.onclick = () => launchPlayer(cls.url);
            todayClasses.appendChild(div);
          });
        }
      } catch (e) {
        console.error(e);
        alert("Error loading subjects");
      }
    }

    async function loadChapters(batchId, subjectSlug) {
      currentSubjectSlug = subjectSlug;
      show(chapters);
      chapters.innerHTML = "";
      try {
        const res = await fetch(`${API}/api/batch/${batchId}/subject/${subjectSlug}/topics?page=1`);
        const result = await res.json();
        (result.data || []).forEach(ch => {
          createCard(chapters, ch.name, null, () => {
            viewStack.push(() => loadChapters(batchId, subjectSlug));
            loadLectures(batchId, subjectSlug, ch._id);
          });
        });
      } catch (e) {
        alert("Error loading chapters");
      }
    }

    function switchTab(type) {
      currentType = type;
      loadLectures(currentBatch, currentSubjectSlug, currentTopicId);
    }

    async function loadLectures(batchId, subjectSlug, topicId) {
      currentTopicId = topicId;
      show(lectureSection);
      lectureContent.innerHTML = "";
      try {
        const res = await fetch(`${API}/api/batch/${batchId}/subject/${subjectSlug}/topic/${topicId}/all-contents?type=${currentType}&page=1`);
        const result = await res.json();
        (result.data || []).forEach(item => {
          const div = document.createElement("div");
          div.className = "card";

          if (["notes", "DppNotes"].includes(currentType)) {
            const links = (item.homeworkIds || []).flatMap(h => h.attachmentIds || []).map(a =>
              `<button onclick="window.open('${a.baseUrl + a.key}', '_blank')">${a.name}</button>`
            ).join("");
            div.innerHTML = `<div class="card-title">${item.topic || "Note"}</div>${links}`;
          } else {
            const video = item.videoDetails || item;
            const image = video.image || video.thumbnail || "";
            const title = video.name || "Video";
            div.innerHTML = `${image ? `<img src="${image}" />` : ""}<div class="card-title">${title}</div>`;
            div.onclick = () => launchPlayer(video.hls_url || item.url || "");
          }
          lectureContent.appendChild(div);
        });
      } catch (e) {
        alert("Error loading lectures");
      }
    }

    async function launchPlayer(url) {
      if (!url) return alert("Invalid URL");
      if (url.includes("youtube.com") || url.includes("youtu.be")) {
        return window.open(url, "_blank");
      }
      const encoded = encodeURIComponent(url);
      window.location.href = `pwplayer.html?playurl=${encoded}`;
    }

    backBtn.onclick = () => {
      const last = viewStack.pop();
      if (last) last();
    };

    searchInput.addEventListener("input", () => {
      const q = searchInput.value.toLowerCase();
      const filtered = allBatches.filter(b => b.name.toLowerCase().includes(q));
      renderBatches(filtered);
    });

    // Load popup if available
    fetch("/popup.json").then(r => r.json()).then(popup => {
      if (popup.show) {
        popupImage.src = popup.image;
        popupText.textContent = popup.text;
        popupLink.href = popup.link;
        popup.style.display = "block";
      }
    }).catch(console.warn);

    window.onload = loadBatches;
  </script>
</body>
</html>
